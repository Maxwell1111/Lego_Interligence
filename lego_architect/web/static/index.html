<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEGO Architect</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 320px;
            background: #16213e;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #0f3460;
        }

        .viewer {
            flex: 1;
            position: relative;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 5px;
            color: #e94560;
        }

        h2 {
            font-size: 14px;
            font-weight: 500;
            color: #888;
            margin-bottom: 20px;
        }

        h3 {
            font-size: 16px;
            margin: 20px 0 10px;
            color: #e94560;
            border-bottom: 1px solid #0f3460;
            padding-bottom: 5px;
        }

        .section {
            background: #0f3460;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 12px;
            color: #aaa;
            margin-bottom: 4px;
        }

        input, select {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 4px;
            background: #1a1a2e;
            color: #fff;
            margin-bottom: 10px;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: 2px solid #e94560;
        }

        .row {
            display: flex;
            gap: 10px;
        }

        .row > div {
            flex: 1;
        }

        button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            background: #e94560;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 8px;
        }

        button:hover {
            background: #ff6b8a;
        }

        button.secondary {
            background: #0f3460;
            border: 1px solid #e94560;
        }

        button.secondary:hover {
            background: #16213e;
        }

        button.danger {
            background: #ff4444;
        }

        button.danger:hover {
            background: #ff6666;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat {
            background: #1a1a2e;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #e94560;
        }

        .stat-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
        }

        .validation {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .validation.valid {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
        }

        .validation.invalid {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
        }

        .validation-item {
            font-size: 12px;
            margin: 5px 0;
            padding-left: 15px;
            position: relative;
        }

        .validation-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 6px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .validation-item.error::before {
            background: #f44336;
        }

        .validation-item.warning::before {
            background: #ff9800;
        }

        .validation-item.suggestion::before {
            background: #2196f3;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #333;
            color: #fff;
            border-radius: 8px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: #4caf50;
        }

        .toast.error {
            background: #f44336;
        }

        .color-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .color-swatch:hover, .color-swatch.selected {
            border-color: #fff;
        }

        .info-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(22, 33, 62, 0.9);
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 12px;
            color: #aaa;
        }

        .controls-hint {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(22, 33, 62, 0.9);
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 11px;
            color: #888;
        }

        .bom-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 10px;
        }

        .bom-table th, .bom-table td {
            padding: 6px;
            text-align: left;
            border-bottom: 1px solid #0f3460;
        }

        .bom-table th {
            color: #888;
            font-weight: 500;
        }

        #bom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        #bom-modal.show {
            display: flex;
        }

        .modal-content {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            width: auto;
            padding: 0;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .tab {
            flex: 1;
            padding: 8px;
            background: #0f3460;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 12px;
            border-radius: 4px 4px 0 0;
        }

        .tab.active {
            background: #e94560;
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .ai-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #0f3460;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .ai-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .ai-status-dot.available {
            background: #4caf50;
        }

        .ai-status-dot.unavailable {
            background: #ff9800;
        }

        .ai-status-dot.disabled {
            background: #666;
        }

        .ai-disabled-notice {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid #ff9800;
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
            color: #ff9800;
            margin-bottom: 15px;
        }

        .hidden {
            display: none !important;
        }

        textarea {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 4px;
            background: #1a1a2e;
            color: #fff;
            margin-bottom: 10px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        textarea:focus {
            outline: 2px solid #e94560;
        }

        .generating {
            opacity: 0.7;
            pointer-events: none;
        }

        .generating::after {
            content: ' ...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60%, 100% { content: ' ...'; }
        }

        .metrics {
            font-size: 11px;
            color: #888;
            margin-top: 10px;
            padding: 8px;
            background: #1a1a2e;
            border-radius: 4px;
        }

        .metrics-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>LEGO Architect</h1>
            <h2>AI-Powered LEGO Builder</h2>

            <div class="ai-status" id="ai-status">
                <div class="ai-status-dot" id="ai-status-dot"></div>
                <span id="ai-status-text">Checking AI status...</span>
            </div>

            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="part-count">0</div>
                    <div class="stat-label">Parts</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="dimensions">0x0x0</div>
                    <div class="stat-label">Dimensions</div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab" data-tab="ai" id="ai-tab-btn">AI Generate</button>
                <button class="tab active" data-tab="patterns">Patterns</button>
                <button class="tab" data-tab="manual">Manual</button>
            </div>

            <div id="ai-tab" class="tab-content">
                <div class="ai-disabled-notice hidden" id="ai-disabled-notice">
                    AI features are currently unavailable. Use Patterns or Manual tabs to build.
                </div>
                <div class="section" id="ai-generate-section">
                    <h3>Generate with AI</h3>
                    <label>Describe your build</label>
                    <textarea id="ai-prompt" placeholder="e.g., A small red house with a blue roof and a chimney"></textarea>
                    <div class="row">
                        <div>
                            <label>Size</label>
                            <select id="ai-size">
                                <option value="">Auto</option>
                                <option value="Small (10-30 parts)">Small</option>
                                <option value="Medium (50-100 parts)" selected>Medium</option>
                                <option value="Large (150+ parts)">Large</option>
                            </select>
                        </div>
                        <div>
                            <label>Style</label>
                            <select id="ai-style">
                                <option value="">Auto</option>
                                <option value="Simple/minimalist">Simple</option>
                                <option value="Detailed/realistic">Detailed</option>
                                <option value="Creative/artistic">Creative</option>
                            </select>
                        </div>
                    </div>
                    <label>
                        <input type="checkbox" id="ai-clear" checked> Clear existing build
                    </label>
                    <button onclick="generateWithAI()" id="ai-generate-btn">Generate Build</button>
                    <div id="ai-metrics" class="metrics hidden"></div>
                </div>
            </div>

            <div id="patterns-tab" class="tab-content active">
                <div class="section">
                    <h3>Base Plate</h3>
                    <div class="row">
                        <div>
                            <label>Start X</label>
                            <input type="number" id="base-x" value="0">
                        </div>
                        <div>
                            <label>Start Z</label>
                            <input type="number" id="base-z" value="0">
                        </div>
                    </div>
                    <div class="row">
                        <div>
                            <label>Width</label>
                            <input type="number" id="base-width" value="10">
                        </div>
                        <div>
                            <label>Length</label>
                            <input type="number" id="base-length" value="10">
                        </div>
                    </div>
                    <label>Color</label>
                    <div class="color-picker" id="base-colors"></div>
                    <button onclick="createBase()">Create Base</button>
                </div>

                <div class="section">
                    <h3>Wall</h3>
                    <div class="row">
                        <div>
                            <label>Start X</label>
                            <input type="number" id="wall-x" value="0">
                        </div>
                        <div>
                            <label>Start Z</label>
                            <input type="number" id="wall-z" value="0">
                        </div>
                    </div>
                    <div class="row">
                        <div>
                            <label>Start Y</label>
                            <input type="number" id="wall-y" value="1">
                        </div>
                        <div>
                            <label>Direction</label>
                            <select id="wall-direction">
                                <option value="x">X-axis</option>
                                <option value="z">Z-axis</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div>
                            <label>Length</label>
                            <input type="number" id="wall-length" value="10">
                        </div>
                        <div>
                            <label>Height</label>
                            <input type="number" id="wall-height" value="9">
                        </div>
                    </div>
                    <label>Color</label>
                    <div class="color-picker" id="wall-colors"></div>
                    <button onclick="createWall()">Create Wall</button>
                </div>

                <div class="section">
                    <h3>Column</h3>
                    <div class="row">
                        <div>
                            <label>X</label>
                            <input type="number" id="col-x" value="0">
                        </div>
                        <div>
                            <label>Z</label>
                            <input type="number" id="col-z" value="0">
                        </div>
                    </div>
                    <div class="row">
                        <div>
                            <label>Height</label>
                            <input type="number" id="col-height" value="12">
                        </div>
                        <div>
                            <label>Thickness</label>
                            <select id="col-thickness">
                                <option value="1">1 stud</option>
                                <option value="2" selected>2 studs</option>
                                <option value="3">3 studs</option>
                                <option value="4">4 studs</option>
                            </select>
                        </div>
                    </div>
                    <label>Color</label>
                    <div class="color-picker" id="col-colors"></div>
                    <button onclick="createColumn()">Create Column</button>
                </div>
            </div>

            <div id="manual-tab" class="tab-content">
                <div class="section">
                    <h3>Add Brick</h3>
                    <label>Brick Type</label>
                    <select id="brick-type" onchange="updateBrickDimensions()">
                        <option value="3001" data-w="2" data-l="4" data-h="3">Brick 2x4</option>
                        <option value="3003" data-w="2" data-l="2" data-h="3">Brick 2x2</option>
                        <option value="3004" data-w="1" data-l="2" data-h="3">Brick 1x2</option>
                        <option value="3005" data-w="1" data-l="1" data-h="3">Brick 1x1</option>
                        <option value="3010" data-w="1" data-l="4" data-h="3">Brick 1x4</option>
                        <option value="3037" data-w="2" data-l="4" data-h="1">Plate 2x4</option>
                        <option value="3022" data-w="2" data-l="2" data-h="1">Plate 2x2</option>
                        <option value="3024" data-w="1" data-l="1" data-h="1">Plate 1x1</option>
                    </select>
                    <div class="row">
                        <div>
                            <label>X</label>
                            <input type="number" id="brick-x" value="0">
                        </div>
                        <div>
                            <label>Z</label>
                            <input type="number" id="brick-z" value="0">
                        </div>
                        <div>
                            <label>Y</label>
                            <input type="number" id="brick-y" value="0">
                        </div>
                    </div>
                    <label>Rotation</label>
                    <select id="brick-rotation">
                        <option value="0">0째</option>
                        <option value="90">90째</option>
                        <option value="180">180째</option>
                        <option value="270">270째</option>
                    </select>
                    <label>Color</label>
                    <div class="color-picker" id="brick-colors"></div>
                    <button onclick="addBrick()">Add Brick</button>
                </div>
            </div>

            <h3>Actions</h3>
            <button onclick="validateBuild()">Validate Build</button>
            <button class="secondary" onclick="showBom()">View BOM</button>
            <button class="secondary" onclick="downloadLdraw()">Download LDraw</button>
            <button class="danger" onclick="clearBuild()">Clear Build</button>

            <div id="validation-results"></div>
        </div>

        <div class="viewer">
            <div id="canvas-container"></div>
            <div class="info-bar">
                <span id="build-name">My LEGO Build</span>
            </div>
            <div class="controls-hint">
                Left-click + drag: Rotate | Right-click + drag: Pan | Scroll: Zoom
            </div>
        </div>
    </div>

    <div id="bom-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Bill of Materials</h3>
                <button class="modal-close" onclick="closeBom()">&times;</button>
            </div>
            <div id="bom-content"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // LEGO color definitions (LDraw color codes)
        const COLORS = {
            0: { name: 'Black', hex: '#1B2A34' },
            1: { name: 'Blue', hex: '#1E5AA8' },
            2: { name: 'Green', hex: '#00852B' },
            4: { name: 'Red', hex: '#B40000' },
            14: { name: 'Yellow', hex: '#FFD700' },
            15: { name: 'White', hex: '#FFFFFF' },
            19: { name: 'Tan', hex: '#E4CD9E' },
            25: { name: 'Orange', hex: '#FE8A18' },
            70: { name: 'Reddish Brown', hex: '#582A12' },
            71: { name: 'Light Bluish Gray', hex: '#A0A5A9' },
            72: { name: 'Dark Bluish Gray', hex: '#6C6E68' },
        };

        let selectedColors = {
            'base-colors': 71,
            'wall-colors': 4,
            'col-colors': 15,
            'brick-colors': 4
        };

        // Three.js setup
        let scene, camera, renderer, controls;
        let brickMeshes = new Map();

        function initThree() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);

            const container = document.getElementById('canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            camera.position.set(30, 25, 30);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(20, 40, 20);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // Grid helper
            const gridHelper = new THREE.GridHelper(50, 50, 0x444444, 0x333333);
            scene.add(gridHelper);

            // Axes helper
            const axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function createBrickGeometry(width, length, height, hasStuds = true) {
            const group = new THREE.Group();

            // Main brick body
            const bodyGeom = new THREE.BoxGeometry(width, height * 0.8, length);
            const bodyMesh = new THREE.Mesh(bodyGeom);
            bodyMesh.position.y = height * 0.4;
            group.add(bodyMesh);

            // Add studs on top
            if (hasStuds && height >= 1) {
                const studRadius = 0.3;
                const studHeight = 0.2;
                const studGeom = new THREE.CylinderGeometry(studRadius, studRadius, studHeight, 16);

                for (let x = 0; x < width; x++) {
                    for (let z = 0; z < length; z++) {
                        const stud = new THREE.Mesh(studGeom);
                        stud.position.set(
                            x - (width - 1) / 2,
                            height * 0.8 + studHeight / 2,
                            z - (length - 1) / 2
                        );
                        group.add(stud);
                    }
                }
            }

            return group;
        }

        function addBrickToScene(part) {
            const color = COLORS[part.color]?.hex || '#888888';
            const material = new THREE.MeshPhongMaterial({
                color: color,
                shininess: 30
            });

            // Calculate dimensions considering rotation
            let width = part.width;
            let length = part.length;
            if (part.rotation === 90 || part.rotation === 270) {
                [width, length] = [length, width];
            }

            // Create brick geometry (scale: 1 unit = 1 stud)
            const brick = createBrickGeometry(width, length, part.height / 3);

            brick.traverse(child => {
                if (child instanceof THREE.Mesh) {
                    child.material = material;
                    child.castShadow = true;
                    child.receiveShadow = true;
                }
            });

            // Position: convert stud coordinates to scene coordinates
            brick.position.set(
                part.x + width / 2,
                part.y / 3, // Convert plates to brick units
                part.z + length / 2
            );

            scene.add(brick);
            brickMeshes.set(part.id, brick);
        }

        function clearScene() {
            brickMeshes.forEach((mesh, id) => {
                scene.remove(mesh);
            });
            brickMeshes.clear();
        }

        // Initialize color pickers
        function initColorPickers() {
            ['base-colors', 'wall-colors', 'col-colors', 'brick-colors'].forEach(id => {
                const container = document.getElementById(id);
                Object.entries(COLORS).forEach(([code, { name, hex }]) => {
                    const swatch = document.createElement('div');
                    swatch.className = 'color-swatch';
                    swatch.style.backgroundColor = hex;
                    swatch.title = name;
                    swatch.dataset.color = code;
                    if (parseInt(code) === selectedColors[id]) {
                        swatch.classList.add('selected');
                    }
                    swatch.onclick = () => selectColor(id, parseInt(code));
                    container.appendChild(swatch);
                });
            });
        }

        function selectColor(pickerId, colorCode) {
            selectedColors[pickerId] = colorCode;
            const container = document.getElementById(pickerId);
            container.querySelectorAll('.color-swatch').forEach(s => {
                s.classList.toggle('selected', parseInt(s.dataset.color) === colorCode);
            });
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
            };
        });

        // Toast notifications
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // API calls
        async function fetchBuild() {
            const res = await fetch('/api/builds');
            const build = await res.json();
            updateUI(build);
            return build;
        }

        function updateUI(build) {
            document.getElementById('part-count').textContent = build.part_count;
            document.getElementById('dimensions').textContent =
                `${build.dimensions[0]}x${build.dimensions[1]}x${build.dimensions[2]}`;
            document.getElementById('build-name').textContent = build.name;

            // Update 3D scene
            clearScene();
            build.parts.forEach(part => addBrickToScene(part));
        }

        async function createBase() {
            const data = {
                start_x: parseInt(document.getElementById('base-x').value),
                start_z: parseInt(document.getElementById('base-z').value),
                width: parseInt(document.getElementById('base-width').value),
                length: parseInt(document.getElementById('base-length').value),
                color: selectedColors['base-colors']
            };

            const res = await fetch('/api/patterns/base', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                const result = await res.json();
                showToast(`Base created: ${result.parts_added} parts`);
                fetchBuild();
            } else {
                showToast('Failed to create base', 'error');
            }
        }

        async function createWall() {
            const data = {
                start_x: parseInt(document.getElementById('wall-x').value),
                start_z: parseInt(document.getElementById('wall-z').value),
                start_y: parseInt(document.getElementById('wall-y').value),
                length: parseInt(document.getElementById('wall-length').value),
                height: parseInt(document.getElementById('wall-height').value),
                direction: document.getElementById('wall-direction').value,
                color: selectedColors['wall-colors']
            };

            const res = await fetch('/api/patterns/wall', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                const result = await res.json();
                showToast(`Wall created: ${result.parts_added} parts`);
                fetchBuild();
            } else {
                showToast('Failed to create wall', 'error');
            }
        }

        async function createColumn() {
            const data = {
                x: parseInt(document.getElementById('col-x').value),
                z: parseInt(document.getElementById('col-z').value),
                height: parseInt(document.getElementById('col-height').value),
                thickness: parseInt(document.getElementById('col-thickness').value),
                color: selectedColors['col-colors']
            };

            const res = await fetch('/api/patterns/column', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                const result = await res.json();
                showToast(`Column created: ${result.parts_added} parts`);
                fetchBuild();
            } else {
                showToast('Failed to create column', 'error');
            }
        }

        function updateBrickDimensions() {
            const select = document.getElementById('brick-type');
            const option = select.options[select.selectedIndex];
            // Dimensions are stored in data attributes
        }

        async function addBrick() {
            const select = document.getElementById('brick-type');
            const option = select.options[select.selectedIndex];

            const data = {
                part_id: select.value,
                part_name: option.textContent,
                color: selectedColors['brick-colors'],
                x: parseInt(document.getElementById('brick-x').value),
                z: parseInt(document.getElementById('brick-z').value),
                y: parseInt(document.getElementById('brick-y').value),
                rotation: parseInt(document.getElementById('brick-rotation').value),
                width: parseInt(option.dataset.w),
                length: parseInt(option.dataset.l),
                height: parseInt(option.dataset.h)
            };

            const res = await fetch('/api/builds/parts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                showToast('Brick added');
                fetchBuild();
            } else {
                const err = await res.json();
                showToast(err.detail || 'Failed to add brick', 'error');
            }
        }

        async function validateBuild() {
            const res = await fetch('/api/validation');
            const result = await res.json();

            const container = document.getElementById('validation-results');
            let html = `<div class="validation ${result.is_valid ? 'valid' : 'invalid'}">`;
            html += `<strong>${result.is_valid ? 'Build Valid' : 'Build Invalid'}</strong>`;

            result.errors.forEach(e => {
                html += `<div class="validation-item error">${e}</div>`;
            });
            result.warnings.forEach(w => {
                html += `<div class="validation-item warning">${w}</div>`;
            });
            result.suggestions.forEach(s => {
                html += `<div class="validation-item suggestion">${s}</div>`;
            });

            html += '</div>';
            container.innerHTML = html;

            showToast(result.is_valid ? 'Build is valid!' : 'Build has issues', result.is_valid ? 'success' : 'error');
        }

        async function showBom() {
            const res = await fetch('/api/export/bom');
            const bom = await res.json();

            let html = `<p><strong>Total Parts:</strong> ${bom.total_parts} | <strong>Unique:</strong> ${bom.unique_parts}</p>`;
            html += '<table class="bom-table"><thead><tr><th>Part</th><th>Color</th><th>Qty</th></tr></thead><tbody>';

            bom.entries.forEach(entry => {
                html += `<tr>
                    <td>${entry.part_name}<br><small>${entry.part_id}</small></td>
                    <td>${entry.color_name}</td>
                    <td>${entry.quantity}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('bom-content').innerHTML = html;
            document.getElementById('bom-modal').classList.add('show');
        }

        function closeBom() {
            document.getElementById('bom-modal').classList.remove('show');
        }

        async function downloadLdraw() {
            const res = await fetch('/api/export/ldraw/download');
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lego_build.ldr';
            a.click();
            window.URL.revokeObjectURL(url);
            showToast('LDraw file downloaded');
        }

        async function clearBuild() {
            if (!confirm('Clear all parts from the build?')) return;

            const res = await fetch('/api/builds/clear', { method: 'POST' });
            if (res.ok) {
                showToast('Build cleared');
                fetchBuild();
                document.getElementById('validation-results').innerHTML = '';
            }
        }

        // AI Status tracking
        let aiAvailable = false;

        async function checkAIStatus() {
            try {
                const res = await fetch('/api/generate/status');
                const status = await res.json();

                const dot = document.getElementById('ai-status-dot');
                const text = document.getElementById('ai-status-text');
                const notice = document.getElementById('ai-disabled-notice');
                const section = document.getElementById('ai-generate-section');

                if (status.ai_available) {
                    dot.className = 'ai-status-dot available';
                    text.textContent = `AI Ready (${status.model || 'Claude'})`;
                    aiAvailable = true;
                    notice.classList.add('hidden');
                    section.classList.remove('hidden');
                } else if (status.ai_enabled) {
                    dot.className = 'ai-status-dot unavailable';
                    text.textContent = 'AI Enabled (API key missing)';
                    aiAvailable = false;
                    notice.textContent = status.message;
                    notice.classList.remove('hidden');
                    section.classList.add('hidden');
                } else {
                    dot.className = 'ai-status-dot disabled';
                    text.textContent = 'AI Disabled';
                    aiAvailable = false;
                    notice.textContent = status.message;
                    notice.classList.remove('hidden');
                    section.classList.add('hidden');
                }
            } catch (e) {
                const dot = document.getElementById('ai-status-dot');
                const text = document.getElementById('ai-status-text');
                dot.className = 'ai-status-dot unavailable';
                text.textContent = 'AI Status Unknown';
                aiAvailable = false;
            }
        }

        async function generateWithAI() {
            if (!aiAvailable) {
                showToast('AI features are not available', 'error');
                return;
            }

            const prompt = document.getElementById('ai-prompt').value.trim();
            if (!prompt) {
                showToast('Please enter a description', 'error');
                return;
            }

            const btn = document.getElementById('ai-generate-btn');
            const metricsDiv = document.getElementById('ai-metrics');
            btn.classList.add('generating');
            btn.textContent = 'Generating';
            metricsDiv.classList.add('hidden');

            try {
                const data = {
                    prompt: prompt,
                    size: document.getElementById('ai-size').value || null,
                    style: document.getElementById('ai-style').value || null,
                    clear_existing: document.getElementById('ai-clear').checked
                };

                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    showToast(`Build generated: ${result.part_count} parts`);
                    fetchBuild();

                    // Show metrics if available
                    if (result.metrics) {
                        metricsDiv.innerHTML = `
                            <div class="metrics-item"><span>Duration:</span><span>${result.metrics.duration_seconds?.toFixed(1) || '?'}s</span></div>
                            <div class="metrics-item"><span>Tokens:</span><span>${result.metrics.total_tokens?.toLocaleString() || '?'}</span></div>
                            <div class="metrics-item"><span>Cached:</span><span>${result.metrics.cached_tokens?.toLocaleString() || '0'}</span></div>
                            <div class="metrics-item"><span>Est. Cost:</span><span>$${result.metrics.total_cost_usd?.toFixed(4) || '?'}</span></div>
                        `;
                        metricsDiv.classList.remove('hidden');
                    }
                } else {
                    showToast(result.message || 'Generation failed', 'error');
                    if (result.errors?.length) {
                        console.error('Generation errors:', result.errors);
                    }
                }
            } catch (e) {
                showToast('Failed to generate build: ' + e.message, 'error');
            } finally {
                btn.classList.remove('generating');
                btn.textContent = 'Generate Build';
            }
        }

        // Initialize
        initThree();
        initColorPickers();
        checkAIStatus();
        fetchBuild();
    </script>
</body>
</html>
